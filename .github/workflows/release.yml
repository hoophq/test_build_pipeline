name: Test Build

on:
  push:

jobs:
  build-rust-binaries-darwin:
    runs-on: macos-latest
    name: Build Darwin Rust Binaries
    environment: production

    steps:
      - name: Checkout Hoop
        uses: actions/checkout@v3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy
          override: true

      - name: Add Darwin Rust targets
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: Set Git Tag
        run: echo "GIT_TAG=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: Build Darwin Rust Binaries
        env:
          GIT_TAG: ${{ env.GIT_TAG }}
        run: make build-rust-darwin-all

      - uses: actions/upload-artifact@v4
        with:
          name: dist-artifacts-${{ github.job }}
          path: dist/

  build-rust-binaries-linux:
    runs-on: ubuntu-latest
    name: Build Linux Rust Binaries
    environment: production

    steps:
      - name: Checkout Hoop
        uses: actions/checkout@v3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy
          override: true

      - name: Add Linux Rust targets
        run: |
          rustup target add x86_64-unknown-linux-gnu
          rustup target add aarch64-unknown-linux-gnu

      - name: Set Git Tag
        run: echo "GIT_TAG=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: Build Linux Rust Binaries
        env:
          GIT_TAG: ${{ env.GIT_TAG }}
        run: make build-rust-linux-all

      - uses: actions/upload-artifact@v4
        with:
          name: dist-artifacts-${{ github.job }}
          path: dist/

  darwin-amd64:
    runs-on: ubuntu-latest
    name: Build Darwin Amd64
    environment: production

    steps:
      - name: Checkout Hoop
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ">=1.23.8"
          cache-dependency-path: "**/go.sum"

      - name: Set Git Tag
        run: echo "GIT_TAG=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: amd64
        env:
          GIT_TAG: ${{ env.GIT_TAG }}
        run: GOOS=darwin GOARCH=amd64 make build-go

      - uses: actions/upload-artifact@v4
        with:
          name: dist-artifacts-${{ github.job }}
          path: dist/

  darwin-arm64:
    runs-on: ubuntu-latest
    name: Build Darwin Arm64
    environment: production

    steps:
      - name: Checkout Hoop
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ">=1.23.8"
          cache-dependency-path: "**/go.sum"

      - name: Set Git Tag
        run: echo "GIT_TAG=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: Build
        env:
          GIT_TAG: ${{ env.GIT_TAG }}
        run: GOOS=darwin GOARCH=arm64 make build-go

      - uses: actions/upload-artifact@v4
        with:
          name: dist-artifacts-${{ github.job }}
          path: dist/

  windows-amd64:
    runs-on: ubuntu-latest
    name: Build Windows Amd64
    environment: production

    steps:
      - name: Checkout Hoop
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ">=1.23.8"
          cache-dependency-path: "**/go.sum"

      - name: Set Git Tag
        run: echo "GIT_TAG=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: Build
        env:
          GIT_TAG: ${{ env.GIT_TAG }}
        run: GOOS=windows GOARCH=amd64 make build-go

      - uses: actions/upload-artifact@v4
        with:
          name: dist-artifacts-${{ github.job }}
          path: dist/

  windows-arm64:
    runs-on: ubuntu-latest
    name: Build Windows Arm64
    environment: production

    steps:
      - name: Checkout Hoop
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ">=1.23.8"
          cache-dependency-path: "**/go.sum"

      - name: Set Git Tag
        run: echo "GIT_TAG=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: Build
        env:
          GIT_TAG: ${{ env.GIT_TAG }}
        run: GOOS=windows GOARCH=arm64 make build-go

      - uses: actions/upload-artifact@v4
        with:
          name: dist-artifacts-${{ github.job }}
          path: dist/

  linux-amd64:
    runs-on: ubuntu-latest
    name: Build Linux Amd64
    environment: production

    steps:
      - name: Checkout Hoop
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ">=1.23.8"
          cache-dependency-path: "**/go.sum"

      - name: Set Git Tag
        run: echo "GIT_TAG=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: Build
        run: GOOS=linux GOARCH=amd64 make build-go

      - uses: actions/upload-artifact@v4
        with:
          name: dist-artifacts-${{ github.job }}
          path: dist/

  linux-arm64:
    runs-on: ubuntu-latest
    name: Build Linux Arm64
    environment: production

    steps:
      - name: Checkout Hoop
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ">=1.23.8"
          cache-dependency-path: "**/go.sum"

      - name: Set Git Tag
        run: echo "GIT_TAG=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: Build
        run: GOOS=linux GOARCH=arm64 make build-go

      - uses: actions/upload-artifact@v4
        with:
          name: dist-artifacts-${{ github.job }}
          path: dist/

  build-webapp:
    runs-on: ubuntu-latest
    name: Build Webapp
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "21"
      - name: Install clojure tools
        uses: DeLaGuardo/setup-clojure@12.5
        with:
          cli: 1.12.0.1479 # releases: https://clojure.org/releases/tools
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: webapp/package-lock.json
      - name: Build
        run: make build-webapp
      - uses: actions/upload-artifact@v4
        with:
          name: dist-artifacts-${{ github.job }}
          path: dist/

  build-tar-files:
    runs-on: ubuntu-latest
    name: Build Tar Files
    environment: production
    needs: [darwin-amd64, darwin-arm64, windows-amd64, windows-arm64, linux-amd64, linux-arm64, build-webapp, build-rust-binaries-darwin, build-rust-binaries-linux]
    steps:
      - name: Checkout Hoop
        uses: actions/checkout@v3
        
      - name: Download Artifacts
        id: download-artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: dist-artifacts-*
          merge-archive: true
          path: .
          if-no-files-found: warn
          
      - name: Merge Artifacts into dist/
        run: |
          echo "=== Merging artifacts into dist/ directory ==="
          mkdir -p dist
          # Merge all dist-artifacts-* directories into dist/
          for artifact_dir in dist-artifacts-*; do
            if [ -d "$artifact_dir" ]; then
              echo "Processing $artifact_dir..."
              # Check what's inside the artifact directory
              if [ -d "$artifact_dir/dist" ]; then
                # Artifact contains dist/ subdirectory - merge its contents
                echo "  Found dist/ subdirectory, merging contents..."
                if [ -d "$artifact_dir/dist/binaries" ]; then
                  # Merge binaries directories
                  mkdir -p dist/binaries
                  cp -r "$artifact_dir/dist/binaries"/* dist/binaries/ 2>/dev/null || true
                fi
                # Copy any other files from dist/
                cp -r "$artifact_dir/dist"/* dist/ 2>/dev/null || true
              else
                # Artifact might be the dist directory itself
                echo "  No dist/ subdirectory found, checking contents..."
                ls -la "$artifact_dir" || true
                # Try to copy if it looks like it contains binaries
                if [ -d "$artifact_dir/binaries" ]; then
                  mkdir -p dist/binaries
                  cp -r "$artifact_dir/binaries"/* dist/binaries/ 2>/dev/null || true
                fi
              fi
            fi
          done
          echo ""
          echo "=== Contents of merged dist/ directory ==="
          if [ -d "dist" ]; then
            find dist -type f -o -type d | head -30 || true
          else
            echo "dist directory was not created"
          fi
          
      - name: Verify Artifacts Downloaded
        run: |
          echo "=== Checking for dist directory ==="
          if [ ! -d "dist" ]; then
            echo "ERROR: dist directory not found after downloading artifacts"
            echo ""
            echo "This could mean:"
            echo "1. The dependent jobs didn't create artifacts"
            echo "2. The artifacts are empty"
            echo "3. The artifact download failed"
            echo ""
            echo "Expected artifacts from these jobs:"
            echo "  - darwin-amd64"
            echo "  - darwin-arm64"
            echo "  - windows-amd64"
            echo "  - windows-arm64"
            echo "  - linux-amd64"
            echo "  - linux-arm64"
            echo "  - build-webapp"
            echo "  - build-rust-binaries-darwin"
            echo "  - build-rust-binaries-linux"
            echo ""
            echo "Checking what was actually downloaded..."
            ls -la || true
            echo ""
            echo "Checking if any artifacts exist..."
            find . -type d -name "dist*" 2>/dev/null || echo "No dist directories found"
            echo ""
            echo "Checking download step status..."
            if [ "${{ steps.download-artifacts.outcome }}" != "success" ]; then
              echo "WARNING: Download step did not succeed"
            fi
            exit 1
          fi
          echo "âœ“ dist directory found"
          echo "Artifacts downloaded successfully"
          
      - name: Debug - List Downloaded Artifacts
        run: |
          echo "=== Current directory structure ==="
          ls -la || true
          echo ""
          echo "=== Contents of dist (if exists) ==="
          ls -la dist/ || true
          echo ""
          echo "=== Contents of dist/binaries (if exists) ==="
          find dist/binaries -type f -o -type d 2>/dev/null | head -20 || echo "dist/binaries does not exist"
          echo ""
          echo "=== All files in current directory (recursive) ==="
          find . -type f -name "main" -o -name "hoop_rs" -o -name "*.tar.gz" 2>/dev/null | head -20 || true
          echo ""
          echo "=== Directory tree (first 3 levels) ==="
          find . -maxdepth 3 -type d 2>/dev/null | sort || true
          
      - name: Build Tar Files for All Architectures
        run: |
          GOOS=darwin GOARCH=amd64 make build-tar-files
          GOOS=darwin GOARCH=arm64 make build-tar-files
          GOOS=windows GOARCH=amd64 make build-tar-files
          GOOS=windows GOARCH=arm64 make build-tar-files
          GOOS=linux GOARCH=amd64 make build-tar-files
          GOOS=linux GOARCH=arm64 make build-tar-files
        
      - uses: actions/upload-artifact@v4
        with:
          name: dist-artifacts-${{ github.job }}
          path: dist/
